name: CI - Build and Test

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-web:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: Install web dependencies
      run: |
        cd web
        npm ci

    - name: Type check web
      run: |
        cd web
        npx tsc --noEmit

    - name: Build web terminal
      run: |
        cd web
        npm run build
      env:
        GITHUB_REPOSITORY: ${{ github.repository }}
        NODE_ENV: production

    - name: Verify web build output
      run: |
        test -d web/dist || exit 1
        test -f web/dist/index.html || exit 1

    - name: Upload web build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: web-build
        path: web/dist/
        retention-days: 7

  build-package:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: Install root dependencies
      run: npm ci

    - name: Type check package
      run: |
        npx tsc -p tsconfig.package.json --noEmit

    - name: Build package
      run: npm run build:package

    - name: Verify package build output
      run: |
        test -f dist/clay-util.js || exit 1
        test -f dist/clay-util.esm.js || exit 1
        test -f dist/clay-util.d.ts || exit 1

    - name: Upload package build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: package-build
        path: dist/
        retention-days: 7
